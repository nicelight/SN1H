# PRD — Telegram Azan Bot

## Проблема
HomeAssistant должен получать ежедневные времена азана в машинно‑читаемом виде, а исходный источник доступен только через Telegram‑бота.

## Пользователь и ценность
- Пользователь: владелец HomeAssistant.
- Ценность: стабильные таймстампы для автоматизаций (без ручного ввода и ошибок).

## Функциональные требования (MVP)
1. Бот отправляет в группу сообщение "Имрӯз" раз в 5 минут до получения релевантного ответа от `@vaktiNamozBot`.
2. Бот принимает все сообщения от `@vaktiNamozBot` и пытается их парсить (reply не требуется).
3. Релевантность: дата в первой строке сообщения совпадает с "сегодня" в TZ `+05:00`, где новый день начинается в 02:00.
4. Дата парсится из первых 10 символов строки (формат `DD.MM.YYYY`); время получения сообщения не используется.
5. Парсинг обязательных полей:
   - `Субҳ` -> `fajr`
   - `Қиём` -> `dhuhr`
   - `Аср` -> `asr`
   - `Шом` -> `maghrib`
   - `Хуфтан` -> `isha`
6. Парсер устойчив к лишним строкам и пробелам (regex).
7. При успешном парсинге публикуются 5 MQTT сообщений:
   - `azan/today/fajr`
   - `azan/today/dhuhr`
   - `azan/today/asr`
   - `azan/today/maghrib`
   - `azan/today/isha`
8. Формат payload: ISO‑timestamp с TZ `+05:00`, пример `2026-01-29T05:21:00+05:00`.
9. Retain = true для всех топиков. QoS = 1.
10. Кеш последнего успешного результата в файле `today-azan-time.json`.

## MQTT: топики и политика
### Правила именования топиков
- Базовый префикс: `azan/today`.
- Имена молитв — только латиницей и в нижнем регистре.
- Полный список обязателен и фиксирован.

### Обязательный список топиков
- `azan/today/fajr`
- `azan/today/dhuhr`
- `azan/today/asr`
- `azan/today/maghrib`
- `azan/today/isha`

### Политика MQTT (общие принципы)
- QoS = 1, retain = true для всех топиков.
- Переподключение при обрыве с backoff (без агрессивных ретраев).
- Публикация после reconnect выполняется только при изменении данных.
- Идемпотентность: публикация только при изменении данных (сравнение с кешем).

## Пример входного сообщения
```
30.01.2026 - 11 Шаъбон 1447
Субҳ                - 05:51
Тулӯи офтоб         - 07:31
Қиём                - 12:37
Пешин               - 13:00
Аср                 - 15:38
Шом                 - 17:38
Хуфтан              - 19:08
Барои дидани вақтҳои намоз рӯзро аз поён интихоб кунед.
```

## Нефункциональные требования
- Надежность: переподключение к MQTT при обрывах, повторные попытки публикации.
- Идемпотентность: повторная публикация допускается, но только при изменении данных.
- Логи: читаемые, с ротацией по размеру.
- Простота: KISS, один процесс, минимум зависимостей.
- Креды/секреты храним только в `.env`.
- `TELEGRAM_CHAT_ID` задается явно в `.env`.
- Зависимости фиксируем через `requirements.txt`.

## Логирование
- Структурированные сообщения (уровень, время, компонент, событие).
- Ротация логов обязательна.
- Отдельно логировать: отправку запроса, получение ответа, результат парсинга, публикацию MQTT, reconnect/backoff.

## Ограничения
- Источник времени только `@vaktiNamozBot`.
- Парсинг только заданного текстового формата, без локализаций.
- Таймзона фиксирована `+05:00`, новый день начинается в 02:00, без переходов лето/зима.

## Критерии приемки
- При получении сообщения с корректной датой и всеми 5 полями данные публикуются в MQTT.
- При пропуске полей или другой дате публикация не происходит, ретраи продолжаются.
- После успешной публикации ретраи прекращаются до следующего дня (с границей дня в 02:00, TZ `+05:00`).
- Смена календарного дня не останавливает ретраи до получения валидного ответа.
- Кеш создается/обновляется при успехе.
